---
title: 线程安全
date: 2019-09-16 14:17:29
categories: 系统
---

#### 概述

>线程安全指的是线程所属的内存安全。线程开辟的内存块分为堆和栈，堆区存储公共的变量，栈区存储私有的变量。线程安全是指线程所属的堆区的数据不会被修改

#### 如何确保线程安全

##### 设置变量访问权限
* 设置函数为私有变量
> 将函数的变量申明在函数内部，这样的变量会存储到栈区。类比类成员，所有的函数都能修改成员变量，但是数据函数内部的私有变量只能由函数自己访问

* 设置变量可读权限
> 设置变量为只读，只对于常量变量有效

##### 设置变量的拷贝方式

> 虽然变量存在堆区，但是可以在堆区对每个线程引用的变量分别拷贝，使得线程操作所属于自己的变量

##### 锁

> 对操作同一个变量的线程串行化

* 悲观锁（互斥锁）
> 无论什么情况，都走获取，锁住，释放的流程。对于并发很低，数据被修改的可能性很低的情况会浪费逻辑，获取释放需要时间
> 对于读取操作阻塞，影响性能

* 乐观锁
> 假定数据不会被修改，读取的时候不加锁。在更新的时候才判断之前的线程对当前数据是否有修改
version: 每次数据变更增加version,更新是比较version是否变更过
cas: 获取数据的内存值，预期值，新值，比较更新（比较的时候不会发生变更吗？）
