---
title: 主从一致性
categories: 系统
date: 2019-08-16 16:35:53
---



	     +------+  1 Update
	     |client+-----+
	     +-+----+     v
	       |        +-+---+
	2 read |        | M   |
	       v        +--+--+
	     +-+---+       |
	     |  S  +<------+
	     +-----+   3 sync
	    
#### 主从同步 

1. client更新请求发往master
2. client读取请求发往salve
3. masetr更新数据同步到salve

由于第3步，sync同步阶段需要耗时，导致在这期间read到从库的书是旧的数据

#### 解决方案

##### 业务可容忍

主从设计的目的地:读写分离，最大可能的提供读的能力
只要数数据冗余都会有数据一致性延迟的问题，非核心业务，非实时性业务满足最终一致性即可

##### 业务数据分级

分为实时性数据和非实时性数据，实时性数据读写主库

对核心业务单独处理

##### 记录正在sync的查询

提交的update记录到缓存中，设定相对于sync比较长的过期时间
下次的read先判断当前查询是否刚刚update,是读取主库，否读取从库

这里的过期时间设置长点，不然会导致时间过期了但是数据还没同步到从主

设置长了会不会有影响？？ 


设置长时间的过期时间或者不过期,订阅从库的binlog,更新完成删除缓存的key



