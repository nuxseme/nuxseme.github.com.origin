---
title: 任务追踪及事务性
categories: 系统
date: 2019-08-16 14:50:41
---


#### 问题

> 消息队列消费消息，pop一个消息之后，常常要做很多的任务，如何确保这些任务被真正执行了，如何追踪任务执行记录，发生不同的异常如何处理？
> 抽象的模型 M1到来，需要执行任务T1,T2...T8


#### 如何追踪任务

M1-Tn 执行完成之后写入日志文件 或者 写入数据库，看需求可以写入redis 或者数据表固化下来


#### 确实任务事务性
> 这一步非常不好做，通常一个task 有很多业务逻辑，修改不同库的数据
> 假定代码执行到一半，发生了异常，如果不确保任务的事务性，可以出现db1的数据被修改，d2的数据未被修改，下次重新执行任务的时候，db1被再次更新
> 尽量将业务逻辑拆分成原子性，可通过mysql的事务来处理，同时提交业务逻辑和任务的执行结果
> 利用数据库的事务性可以确实任务被执行和任务被记录，这里的拆分就尤为重要 这一步基本上很难做的完善
> 如果是常驻内存的话，针对不同的异常需要特殊处理，（关于数据库连接的异常）


#### Task执行失败如何处理

* 记录异常日志  写入异常队列再次被消费 
* 断点任务是否继续执行 ？ 任务之间是否具有依赖关系？ 比如 T4 依赖T3 完成 具有依赖的任务不能跳过继续执行
* 任务可以类别，实时性，可重复性等特性划分，不同的消费者消费时间方式等可以区分开来

#### 消费进程重启的问题

* 需要做到能平滑重启，不然kill 方式会导致执行一半的任务中断，没有写入到异常队列

php swolle 如何平滑重启?
